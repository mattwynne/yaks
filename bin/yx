#!/usr/bin/env bash

YAK_DIR="${YAK_PATH:-.yaks}"

validate_yak_name() {
  local name="$1"
  # Reject characters that are invalid on POSIX or Windows: / \ : * ? | < > "
  if [[ "$name" =~ [/\\:\*\?\|\<\>\"] ]]; then
    echo "Invalid yak name: contains forbidden characters (/ \\ : * ? | < > \")" >&2
    return 1
  fi
  return 0
}

list_yaks() {
  if [ ! -d "$YAK_DIR" ] || [ -z "$(ls -A "$YAK_DIR" 2>/dev/null)" ]; then
    echo "You have no yaks. Are you done?"
    return
  fi

  for yak_dir in "$YAK_DIR"/*; do
    if [ -d "$yak_dir" ]; then
      local yak_name=$(basename "$yak_dir")
      if [ -f "$yak_dir/done" ]; then
        echo "- [x] $yak_name"
      else
        echo "- [ ] $yak_name"
      fi
    fi
  done
}

show_help() {
  cat <<EOF
Usage: yx <command> [arguments]

Commands:
  add <name>              Add a new yak
  list, ls                List all yaks
  context [--show] <name> Edit context (uses \$EDITOR) or set from stdin
                          --show: Display yak with context
                          --edit: Edit context (default)
  done <name>             Mark a yak as done
  done --undo <name>      Unmark a yak as done
  rm <name>               Remove a yak by name
  prune                   Remove all done yaks
  --help                  Show this help message
EOF
}

case "$1" in
  --help)
    show_help
    ;;
  "")
    show_help
    ;;
  add)
    if [ -z "$2" ]; then
      # Interactive mode
      echo "Enter yaks (empty line to finish):"
      mkdir -p "$YAK_DIR"
      while IFS= read -r line; do
        if [ -z "$line" ]; then
          break
        fi
        validate_yak_name "$line" || exit 1
        mkdir -p "$YAK_DIR/$line"
      done
    else
      # Single yak mode
      yak_name="${*:2}"
      validate_yak_name "$yak_name" || exit 1
      mkdir -p "$YAK_DIR/$yak_name"
    fi
    ;;
  list|ls)
    list_yaks
    ;;
  done)
    if [ "$2" = "--undo" ]; then
      yak_name="${*:3}"
      yak_path="$YAK_DIR/$yak_name"
      if [ ! -d "$yak_path" ]; then
        echo "Error: yak '$yak_name' not found" >&2
        exit 1
      fi
      rm -f "$yak_path/done"
    else
      yak_name="${*:2}"
      yak_path="$YAK_DIR/$yak_name"
      if [ ! -d "$yak_path" ]; then
        echo "Error: yak '$yak_name' not found" >&2
        exit 1
      fi
      touch "$yak_path/done"
    fi
    ;;
  rm)
    yak_name="${*:2}"
    yak_path="$YAK_DIR/$yak_name"
    if [ ! -d "$yak_path" ]; then
      echo "Error: yak '$yak_name' not found" >&2
      exit 1
    fi
    rm -rf "$yak_path"
    ;;
  prune)
    if [ -d "$YAK_DIR" ]; then
      for yak_dir in "$YAK_DIR"/*; do
        if [ -d "$yak_dir" ] && [ -f "$yak_dir/done" ]; then
          rm -rf "$yak_dir"
        fi
      done
    fi
    ;;
  context)
    if [ "$2" = "--show" ]; then
      # Show mode
      yak_name="${*:3}"
      yak_path="$YAK_DIR/$yak_name"
      if [ ! -d "$yak_path" ]; then
        echo "Error: yak '$yak_name' not found" >&2
        exit 1
      fi
      echo "$yak_name"
      if [ -f "$yak_path/context.md" ]; then
        echo
        cat "$yak_path/context.md"
      fi
    else
      # Edit mode (default or --edit)
      if [ "$2" = "--edit" ]; then
        yak_name="${*:3}"
      else
        yak_name="${*:2}"
      fi
      yak_path="$YAK_DIR/$yak_name"
      if [ ! -d "$yak_path" ]; then
        echo "Error: yak '$yak_name' not found" >&2
        exit 1
      fi
      if [ -t 0 ]; then
        # stdin is a terminal, open editor
        ${EDITOR:-vi} "$yak_path/context.md"
      else
        # stdin is piped, read from stdin
        cat > "$yak_path/context.md"
      fi
    fi
    ;;
  *)
    show_help
    ;;
esac
