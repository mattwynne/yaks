#!/usr/bin/env bash

YAK_DIR="${YAK_PATH:-.yaks}"
YAKS_FILE="$YAK_DIR/yks"

show_help() {
  cat <<EOF
Usage: yx <command> [arguments]

Commands:
  add <name>    Add a new yak
  list, ls      List all yaks
  rm <name>     Remove a yak by name
  --help        Show this help message
EOF
}

case "$1" in
  --help)
    show_help
    ;;
  "")
    show_help
    ;;
  add)
    if [ -z "$2" ]; then
      # Interactive mode
      echo "Enter yaks (empty line to finish):"
      mkdir -p "$YAK_DIR"
      while IFS= read -r line; do
        if [ -z "$line" ]; then
          break
        fi
        echo "$line" >> "$YAKS_FILE"
      done
    else
      # Single yak mode
      mkdir -p "$YAK_DIR"
      echo "${*:2}" >> "$YAKS_FILE"
    fi
    ;;
  list|ls)
    if [ -f "$YAKS_FILE" ]; then
      sed 's/^/- [ ] /' "$YAKS_FILE"
    else
      echo "You have no yaks. Are you done?"
    fi
    ;;
  rm)
    yak_name="${*:2}"
    if [ ! -f "$YAKS_FILE" ]; then
      echo "Error: yak '$yak_name' not found" >&2
      exit 1
    fi
    if grep -Fxq "$yak_name" "$YAKS_FILE"; then
      grep -Fxv "$yak_name" "$YAKS_FILE" > "$YAKS_FILE.tmp"
      mv "$YAKS_FILE.tmp" "$YAKS_FILE"
      # Remove the file if it's empty
      if [ ! -s "$YAKS_FILE" ]; then
        rm "$YAKS_FILE"
      fi
    else
      echo "Error: yak '$yak_name' not found" >&2
      exit 1
    fi
    ;;
  *)
    show_help
    ;;
esac
