#!/usr/bin/env bash

YAK_DIR="${YAK_PATH:-.yaks}"

validate_yak_name() {
  local name="$1"
  # Reject characters that are invalid on POSIX or Windows: / \ : * ? | < > "
  if [[ "$name" =~ [/\\:\*\?\|\<\>\"] ]]; then
    echo "Invalid yak name: contains forbidden characters (/ \\ : * ? | < > \")" >&2
    return 1
  fi
  return 0
}

require_yak() {
  local yak_name="$1"
  local yak_path="$YAK_DIR/$yak_name"
  if [ ! -d "$yak_path" ]; then
    echo "Error: yak '$yak_name' not found" >&2
    return 1
  fi
  return 0
}

list_yaks() {
  if [ ! -d "$YAK_DIR" ] || [ -z "$(ls -A "$YAK_DIR" 2>/dev/null)" ]; then
    echo "You have no yaks. Are you done?"
    return
  fi

  # Sort by creation time (oldest first) using ls -tr
  local sorted_dirs
  sorted_dirs=$(ls -tr "$YAK_DIR")

  # First pass: display done yaks
  while IFS= read -r yak_name; do
    local yak_dir="$YAK_DIR/$yak_name"
    if [ -d "$yak_dir" ] && [ -f "$yak_dir/done" ]; then
      echo -e "\e[90m- [x] $yak_name\e[0m"
    fi
  done <<< "$sorted_dirs"

  # Second pass: display undone yaks
  while IFS= read -r yak_name; do
    local yak_dir="$YAK_DIR/$yak_name"
    if [ -d "$yak_dir" ] && [ ! -f "$yak_dir/done" ]; then
      echo "- [ ] $yak_name"
    fi
  done <<< "$sorted_dirs"
}

show_help() {
  cat <<EOF
Usage: yx <command> [arguments]

Commands:
  add <name>              Add a new yak
  list, ls                List all yaks
  context [--show] <name> Edit context (uses \$EDITOR) or set from stdin
                          --show: Display yak with context
                          --edit: Edit context (default)
  done <name>             Mark a yak as done
  done --undo <name>      Unmark a yak as done
  rm <name>               Remove a yak by name
  move <old> <new>        Rename a yak
  mv <old> <new>          Alias for move
  prune                   Remove all done yaks
  completions [cmd]       Output yak names for shell completion
  --help                  Show this help message
EOF
}

add_yak() {
  if [ -z "$1" ]; then
    # Interactive mode
    echo "Enter yaks (empty line to finish):"
    mkdir -p "$YAK_DIR"
    while IFS= read -r line; do
      if [ -z "$line" ]; then
        break
      fi
      validate_yak_name "$line" || exit 1
      mkdir -p "$YAK_DIR/$line"
    done
  else
    # Single yak mode
    local yak_name="$*"
    validate_yak_name "$yak_name" || exit 1
    mkdir -p "$YAK_DIR/$yak_name"
  fi
}

done_yak() {
  if [ "$1" = "--undo" ]; then
    local yak_name="${*:2}"
    require_yak "$yak_name" || exit 1
    local yak_path="$YAK_DIR/$yak_name"
    rm -f "$yak_path/done"
  else
    local yak_name="$*"
    require_yak "$yak_name" || exit 1
    local yak_path="$YAK_DIR/$yak_name"
    touch "$yak_path/done"
  fi
}

remove_yak() {
  local yak_name="$*"
  require_yak "$yak_name" || exit 1
  local yak_path="$YAK_DIR/$yak_name"
  rm -rf "$yak_path"
}

prune_yaks() {
  if [ -d "$YAK_DIR" ]; then
    for yak_dir in "$YAK_DIR"/*; do
      if [ -d "$yak_dir" ] && [ -f "$yak_dir/done" ]; then
        rm -rf "$yak_dir"
      fi
    done
  fi
}

move_yak() {
  local old_name="$1"
  shift
  local new_name="$*"
  require_yak "$old_name" || exit 1
  local old_path="$YAK_DIR/$old_name"
  local new_path="$YAK_DIR/$new_name"
  validate_yak_name "$new_name" || exit 1
  mv "$old_path" "$new_path"
}

context_yak() {
  if [ "$1" = "--show" ]; then
    # Show mode
    local yak_name="${*:2}"
    require_yak "$yak_name" || exit 1
    local yak_path="$YAK_DIR/$yak_name"
    echo "$yak_name"
    if [ -f "$yak_path/context.md" ]; then
      echo
      cat "$yak_path/context.md"
    fi
  else
    # Edit mode (default or --edit)
    if [ "$1" = "--edit" ]; then
      local yak_name="${*:2}"
    else
      local yak_name="$*"
    fi
    require_yak "$yak_name" || exit 1
    local yak_path="$YAK_DIR/$yak_name"
    if [ -t 0 ]; then
      # stdin is a terminal, open editor
      ${EDITOR:-vi} "$yak_path/context.md"
    else
      # stdin is piped, read from stdin
      cat > "$yak_path/context.md"
    fi
  fi
}

completions() {
  # Output yak names for shell completion
  if [ ! -d "$YAK_DIR" ]; then
    return 0
  fi
  local cmd="$1"
  local flag="$2"
  for yak_dir in "$YAK_DIR"/*; do
    if [ -d "$yak_dir" ]; then
      local yak_name
      yak_name=$(basename "$yak_dir")
      case "$cmd" in
        done)
          if [ "$flag" = "--undo" ]; then
            # Only show done yaks
            if [ -f "$yak_dir/done" ]; then
              echo "$yak_name"
            fi
          else
            # Only show incomplete yaks
            if [ ! -f "$yak_dir/done" ]; then
              echo "$yak_name"
            fi
          fi
          ;;
        *)
          # Show all yaks
          echo "$yak_name"
          ;;
      esac
    fi
  done
}

case "$1" in
  --help|"")
    show_help
    ;;
  add)
    shift
    add_yak "$@"
    ;;
  list|ls)
    list_yaks
    ;;
  done)
    shift
    done_yak "$@"
    ;;
  rm)
    shift
    remove_yak "$@"
    ;;
  prune)
    prune_yaks
    ;;
  move|mv)
    shift
    move_yak "$@"
    ;;
  context)
    shift
    context_yak "$@"
    ;;
  completions)
    shift
    completions "$@"
    ;;
  *)
    show_help
    ;;
esac
